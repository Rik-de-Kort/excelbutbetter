<!DOCTYPE html>
<html>
  <head>
      <title>EBB Prototype</title>
      <script src="https://cdn.jsdelivr.net/pyodide/v0.17.0/full/pyodide.js"></script>
  </head>
  <body>
    Hello, world!<br>

    Upload a file <input id="fileUpload" type="file"><br>

    <a id="fileDownload">Download it</a>
    
    <script type="text/javascript">
      async function main(){
        await loadPyodide({
          indexURL : "https://cdn.jsdelivr.net/pyodide/v0.17.0/full/"
        });
        console.log(pyodide.runPython(`
            import sys
            sys.version
            import sqlite3
        `));
        
      }
      main();

      const fileDownload = document.getElementById("fileDownload");
      const fileUpload = document.getElementById("fileUpload");
      let fileUrl = ''
      fileUpload.addEventListener("change", handleFiles, false);
      async function handleFiles(e) {
        console.log("Uploaded a file!");
        self.file = await fileUpload.files[0].arrayBuffer();
        pyodide.runPython(`
          FNAME = 'tmp.sqlite'
          from js import file
          from io import BytesIO
          b = file.to_py().tobytes()
          with open(FNAME, 'wb+') as handle:
            handle.write(b)
          conn = sqlite3.connect(FNAME)
          c = conn.cursor()
          print(c.execute('SELECT * FROM test').fetchall())
          c.execute('insert into test values ("ada", "rik")')
          conn.commit()
        `);

        pyodide.runPython(`
          with open(FNAME, 'rb') as handle:
            b_new = handle.read()
        `);

        const bJs = pyodide.globals.get('b_new');
        const blob = new Blob([bJs.toJs()], {type: 'application/vnd.sqlite3'});
        fileUrl = URL.createObjectURL(blob, 'test.sqlite');
        fileDownload.href = fileUrl;
        fileDownload.download = 'test.sqlite';
      }
      fileDownload.addEventListener("mouseup", async (e) => { setTimeout(() => URL.revokeObjectURL(fileUrl), 1000);});
    </script>
  </body>
</html>
